services:
  app-api:
    container_name: sefimplus-app-api
    build: { context: ., dockerfile: App.Api/Dockerfile }
    image: local/appapi:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - ConnectionStrings__SqlServer=Server=sql-server;Database=${SQL_SERVER_DB};User Id=${SQL_SERVER_USER};Password=${SQL_SERVER_PASSWORD};TrustServerCertificate=True;
    ports: ["5190:8080","7190:8081"]
    networks: [app-network]

  app-ui:
    container_name: sefimplus-app-ui
    build: { context: ., dockerfile: App.UI/Dockerfile }
    image: local/appui:latest
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - DOTNET_RUNNING_IN_CONTAINER=true
      - API_BASE_URL=http://app-api:8080/
      - CacheSettings__ConnectionString=app-redis:6379,password=${REDIS_PASSWORD}
    ports: ["5191:8080","7191:8081"]
    healthcheck: { test: ["CMD", "curl", "-f", "http://localhost:8080"], interval: 10s, timeout: 5s, retries: 3, start_period: 30s }
    networks: [app-network]

  cloudflared:
    container_name: sefimplus-cloudflared
    image: cloudflare/cloudflared:latest
    command: tunnel --config /etc/cloudflared/config.yaml run
    environment: [ "TUNNEL_TOKEN=${CLOUD_TUNNEL_TOKEN}" ]
    volumes: [ ./.cloudflared/config.yaml:/etc/cloudflared/config.yaml:ro ]
    networks: [app-network]
