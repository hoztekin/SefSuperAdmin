@model RoleBasedNavigationViewModel

<nav class="navbar navbar-expand-lg navbar-dark bg-primary @Model.CssClass">
    <div class="container-fluid">
        @if (Model.ShowLogo)
        {
            <a class="navbar-brand" asp-controller="Home" asp-action="Index">
                <img src="~/img/logo.png" height="40" alt="Logo" />
            </a>
        }

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarRoleBasedNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarRoleBasedNav">
            <ul class="navbar-nav me-auto">
                @if (Model.IsAuthenticated)
                {
                    <!-- Ana Sayfa - Herkese görünür -->
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Home" asp-action="Index">
                            <i class="fas fa-home"></i> Ana Sayfa
                        </a>
                    </li>

                    @if (Model.IsAdmin)
                    {
                        <!-- SİSTEM ADMİN MENÜSÜ -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="sistemAdminDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-cogs"></i> Sistem Yönetimi
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" asp-controller="SistemAdmin" asp-action="Index">
                                        <i class="fas fa-tachometer-alt"></i> Admin Dashboard
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" asp-controller="SistemAdmin" asp-action="Users">
                                        <i class="fas fa-users"></i> Kullanıcı Yönetimi
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" asp-controller="Machine" asp-action="Index">
                                        <i class="fas fa-server"></i> Makine Yönetimi
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" asp-controller="SistemAdmin" asp-action="GetSystemStats">
                                        <i class="fas fa-chart-bar"></i> Sistem İstatistikleri
                                    </a>
                                </li>
                            </ul>
                        </li>
                    }
                    else
                    {
                        <!-- NORMAL KULLANICI MENÜSÜ -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="apiServicesDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-plug"></i> API Servisleri
                            </a>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showMachineModal()">
                                        <i class="fas fa-network-wired"></i> Makine Bağlantısı
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="checkSelectedMachineHealth()">
                                        <i class="fas fa-heartbeat"></i> Health Check
                                    </a>
                                </li>
                                @if (Model.HasSelectedMachine)
                                {
                                    <li>
                                        <hr class="dropdown-divider">
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-server text-success"></i> @Model.SelectedMachineName
                                        </h6>
                                        <a class="dropdown-item" asp-controller="Home" asp-action="ApiOperations">
                                            <i class="fas fa-tools"></i> API İşlemleri
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>

            <!-- Sağ taraf - Kullanıcı menüsü -->
            <ul class="navbar-nav">
                @if (Model.IsAuthenticated)
                {
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> @Model.UserName
                            @if (Model.IsAdmin)
                            {
                                <span class="badge badge-warning ml-1">Admin</span>
                            }
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">Rol(ler):</h6></li>
                            @foreach (var role in Model.UserRoles)
                            {
                                <li>
                                    <span class="dropdown-item-text">
                                        <small>
                                            @if (role == "SuperAdmin")
                                            {
                                                <i class="fas fa-crown text-warning"></i> 
                                                @role
                                            }
                                            else if (role == "Admin")
                                            {
                                                <i class="fas fa-user-shield text-primary"></i> 
                                                @role
                                            }
                                            else
                                            {
                                                <i class="fas fa-tag text-info"></i> 
                                                @role
                                            }
                                        </small>
                                    </span>
                                </li>
                            }
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" asp-controller="Password" asp-action="PasswordChange">
                                    <i class="fas fa-key"></i> Şifre Değiştir
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-controller="Authentication" asp-action="Logout">
                                    <i class="fas fa-sign-out-alt"></i> Çıkış
                                </a>
                            </li>
                        </ul>
                    </li>
                }
                else
                {
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Authentication" asp-action="Login">
                            <i class="fas fa-sign-in-alt"></i> Giriş
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="Authentication" asp-action="Register">
                            <i class="fas fa-user-plus"></i> Kayıt
                        </a>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>

<!-- JavaScript for dynamic menu behavior -->
<script>
    // Sayfa yüklendiğinde seçili makine varsa menüyü güncelle
    $(document).ready(function() {
        updateSelectedMachineMenu();
    });

    function updateSelectedMachineMenu() {
        if (!@Json.Serialize(Model.IsAdmin)) {
            $.get('@Url.Action("GetSelectedMachine", "Home")', function(response) {
                if (response.success) {
                    // Menüyü güncelle
                    $('.dropdown-header').html(`<i class="fas fa-server text-success"></i> ${response.data.branchName}`);
                } else {
                    // Seçili makine yok
                    $('.dropdown-header').html('<i class="fas fa-server text-muted"></i> Makine Seçilmemiş');
                }
            }).fail(function() {
                console.log('Seçili makine kontrol edilemedi');
            });
        }
    }

    function showMachineModal() {
        // Bu fonksiyon ana view'da tanımlanmalı veya global olmalı
        if (typeof window.showMachineModal === 'function') {
            window.showMachineModal();
        } else {
            toastr.warning('Makine seçim modalı bulunamadı');
        }
    }

    function checkSelectedMachineHealth() {
        // Bu fonksiyon ana view'da tanımlanmalı veya global olmalı
        if (typeof window.checkSelectedMachineHealth === 'function') {
            window.checkSelectedMachineHealth();
        } else {
            toastr.info('Health check fonksiyonu bulunamadı');
        }
    }
</script>