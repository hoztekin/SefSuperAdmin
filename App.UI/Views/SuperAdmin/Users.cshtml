@model List<UserAppDtoUI>

@{
    ViewData["Title"] = "Kullanıcı Yönetimi";
    Layout = "_Layout";
}

<!-- ViewComponent Navigation -->
@await Component.InvokeAsync("RoleBasedNavigation", new { showLogo = true })

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-users"></i> Kullanıcı Yönetimi</h2>
                    <p class="text-muted">Sistemdeki tüm kullanıcıları yönetin ve rol atayın</p>
                </div>
                <div>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Dashboard'a Dön
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold">
                            <i class="fas fa-list"></i> Kullanıcı Listesi (@Model.Count kullanıcı)
                        </h6>
                        <div>
                            <button onclick="showAddUserModal()" class="btn btn-sm btn-success me-2">
                                <i class="fas fa-plus"></i> Ekle
                            </button>
                            <button onclick="refreshUserList()" class="btn btn-sm btn-light">
                                <i class="fas fa-sync-alt"></i> Yenile
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="usersTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th><i class="fas fa-user"></i> Kullanıcı Adı</th>
                                        <th><i class="fas fa-envelope"></i> Email</th>
                                        <th><i class="fas fa-user-tag"></i> Roller</th>
                                        <th><i class="fas fa-calendar"></i> Kayıt Tarihi</th>
                                        <th><i class="fas fa-check-circle"></i> Email Onayı</th>
                                        <th><i class="fas fa-cog"></i> İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in Model)
                                    {
                                        <tr>
                                            <td class="align-middle">
                                                <strong>@user.UserName</strong>
                                                <br><small class="text-muted">ID: @user.Id.Substring(0, 8)...</small>
                                            </td>
                                            <td class="align-middle">@user.EMail</td>
                                            <td class="align-middle">
                                                @if (user.Roles != null && user.Roles.Any())
                                                {
                                                    @foreach (var role in user.Roles)
                                                    {
                                                        @if (role == "SuperAdmin")
                                                        {
                                                            <span class="badge bg-warning text-dark me-1">
                                                                <i class="fas fa-crown"></i> @role
                                                            </span>
                                                        }
                                                        else if (role == "Admin")
                                                        {
                                                            <span class="badge bg-primary me-1">
                                                                <i class="fas fa-user-shield"></i> @role
                                                            </span>
                                                        }
                                                        else if (role == "Destek")
                                                        {
                                                            <span class="badge bg-info me-1">
                                                                <i class="fas fa-headset"></i> @role
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary me-1">
                                                                <i class="fas fa-user"></i> @role
                                                            </span>
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Rol atanmamış</span>
                                                }
                                            </td>
                                            <td class="align-middle">
                                                @if (user.CreatedDate.HasValue)
                                                {
                                                    @user.CreatedDate.Value.ToString("dd.MM.yyyy HH:mm")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td class="align-middle text-center">
                                                @if (user.EmailConfirmed)
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check"></i> Onaylı
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-clock"></i> Bekliyor
                                                    </span>
                                                }
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group" role="group">
                                                    <a asp-action="AssignRoles" asp-route-userId="@user.Id"
                                                       class="btn btn-sm btn-primary" title="Rol Ata">
                                                        <i class="fas fa-user-tag"></i>
                                                    </a>
                                                    <button onclick="viewUserDetails('@user.Id')"
                                                            class="btn btn-sm btn-info" title="Detaylar">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="showEditUserModal('@user.Id', '@user.UserName', '@user.EMail')"
                                                            class="btn btn-sm btn-warning" title="Düzenle">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteUser('@user.Id', '@user.UserName')"
                                                            class="btn btn-sm btn-danger" title="Sil">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center p-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Kullanıcı Bulunamadı</h5>
                            <p class="text-muted">Henüz sisteme kullanıcı eklenmemiş.</p>
                            <button onclick="showAddUserModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> İlk Kullanıcıyı Ekle
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kullanıcı Ekleme Modal - YENİ TASARIM -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus"></i> Yeni Kullanıcı Ekle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Güvenlik için güçlü bir şifre seçin.
                    </div>

                    <div class="mb-3">
                        <label for="userName" class="form-label">
                            <i class="fas fa-user"></i> Kullanıcı Adı *
                        </label>
                        <input type="text" class="form-control form-control-lg" id="userName" name="userName" required autocomplete="off">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope"></i> Email *
                        </label>
                        <input type="email" class="form-control form-control-lg" id="email" name="email" required autocomplete="off">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock"></i> Şifre *
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-lg" id="password" name="password" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback"></div>
                        <div class="form-text">En az 6 karakter olmalıdır.</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-lock"></i> Şifre Tekrar *
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-lg" id="confirmPassword" name="confirmPassword" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback"></div>
                        <div class="valid-feedback">Şifreler eşleşiyor!</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Kullanıcıyı Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kullanıcı Düzenleme Modal - YENİ TASARIM -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit"></i> Kullanıcı Düzenle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="userId">

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Şifreyi değiştirmek istemiyorsanız boş bırakın.
                    </div>

                    <div class="mb-3">
                        <label for="editUserName" class="form-label">
                            <i class="fas fa-user"></i> Kullanıcı Adı *
                        </label>
                        <input type="text" class="form-control form-control-lg" id="editUserName" name="userName" required>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editEmail" class="form-label">
                            <i class="fas fa-envelope"></i> Email *
                        </label>
                        <input type="email" class="form-control form-control-lg" id="editEmail" name="email" required>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editPassword" class="form-label">
                            <i class="fas fa-lock"></i> Yeni Şifre (Opsiyonel)
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-lg" id="editPassword" name="password" autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="editConfirmPassword" class="form-label">
                            <i class="fas fa-lock"></i> Yeni Şifre Tekrar
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-lg" id="editConfirmPassword" name="confirmPassword" autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editConfirmPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback"></div>
                        <div class="valid-feedback">Şifreler eşleşiyor!</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> İptal
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kullanıcı Detay Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user-tag"></i> Kullanıcı Detayları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetailContent">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script>
         $(document).ready(function() {
            // DataTables sadece tablo varsa yükle
            if ($('#usersTable').length > 0) {
                // DataTables CSS ve JS'i dinamik yükle
                if (!$.fn.DataTable) {
                    $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/css/dataTables.bootstrap5.min.css">');
                    $.getScript('https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/js/jquery.dataTables.min.js', function() {
                        $.getScript('https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/js/dataTables.bootstrap5.min.js', function() {
                            initDataTable();
                        });
                    });
                } else {
                    initDataTable();
                }
            }
        });

        function initDataTable() {
            $('#usersTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Turkish.json"
                },
                "pageLength": 25,
                "order": [[ 3, "desc" ]],
                "columnDefs": [
                    { "orderable": false, "targets": 5 }
                ]
            });
        }

        function refreshUserList() {
            location.reload();
        }

        function showAddUserModal() {
            $('#addUserModal').modal('show');
            $('#addUserForm')[0].reset();
            $('#addUserForm .is-invalid, #addUserForm .is-valid').removeClass('is-invalid is-valid');
        }

        function showEditUserModal(userId, userName, email) {
            $('#editUserModal').modal('show');
            $('#editUserForm')[0].reset();
            $('#editUserForm .is-invalid, #editUserForm .is-valid').removeClass('is-invalid is-valid');

            $('#editUserId').val(userId);
            $('#editUserName').val(userName);
            $('#editEmail').val(email);
        }

        // Şifre görünürlük toggle - window scope'a ekle
        window.togglePassword = function(fieldId, button) {
  
            const field = document.getElementById(fieldId);

            if (!field) {

                return;
            }

            const icon = button.querySelector('i');

            if (!icon) {
     
                return;
            }

            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');

            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');

            }
        }

        // Real-time şifre eşleştirme kontrolü
        function setupPasswordMatching(passwordId, confirmPasswordId) {
            const passwordField = document.getElementById(passwordId);
            const confirmField = document.getElementById(confirmPasswordId);

            function checkMatch() {
                const password = passwordField.value;
                const confirm = confirmField.value;

                if (confirm === '') {
                    confirmField.classList.remove('is-valid', 'is-invalid');
                    return;
                }

                if (password === confirm && password !== '') {
                    confirmField.classList.remove('is-invalid');
                    confirmField.classList.add('is-valid');
                } else {
                    confirmField.classList.remove('is-valid');
                    confirmField.classList.add('is-invalid');
                    const feedbackElement = confirmField.parentElement.parentElement.querySelector('.invalid-feedback');
                    if (feedbackElement) {
                        feedbackElement.textContent = 'Şifreler eşleşmiyor!';
                    }
                }
            }

            passwordField.addEventListener('input', checkMatch);
            confirmField.addEventListener('input', checkMatch);
        }

        // Modal açıldığında setup yap
        $('#addUserModal').on('shown.bs.modal', function () {
           setTimeout(() => {
            setupPasswordMatching('password', 'confirmPassword');
            }, 50);
            $('#userName').focus();
        });

        $('#editUserModal').on('shown.bs.modal', function () {
            setupPasswordMatching('editPassword', 'editConfirmPassword');
            $('#editUserName').focus();
        });

        // Field hata gösterme fonksiyonu
        function showFieldError(fieldId, message) {
            const field = $('#' + fieldId);
            field.addClass('is-invalid');
            field.removeClass('is-valid');

            let feedbackElement;
            if (field.parent().hasClass('input-group')) {
                feedbackElement = field.parent().parent().find('.invalid-feedback');
            } else {
                feedbackElement = field.siblings('.invalid-feedback');
            }
            feedbackElement.text(message);
        }

        // KULLANICI EKLEME - DÜZELTME
        $('#addUserForm').on('submit', async function(e) {
            e.preventDefault();



            // Küçük bir gecikme ekle - browser'ın autocomplete'i tamamlaması için
            await new Promise(resolve => setTimeout(resolve, 100));

            // Form verilerini al - native DOM API kullan
            const form = document.getElementById('addUserForm');
            const formData = new FormData(form);

            const userName = formData.get('userName') || document.getElementById('userName').value;
            const email = formData.get('email') || document.getElementById('email').value;
            const password = formData.get('password') || document.getElementById('password').value;
            const confirmPassword = formData.get('confirmPassword') || document.getElementById('confirmPassword').value;


            // Tüm validation'ları temizle
            $('#addUserForm .is-invalid, #addUserForm .is-valid').removeClass('is-invalid is-valid');

            // Validasyon
            let hasError = false;

            if (!userName || userName.trim() === '') {
                showFieldError('userName', 'Kullanıcı adı gerekli!');
                hasError = true;
            }

            if (!email || email.trim() === '') {
                showFieldError('email', 'Email gerekli!');
                hasError = true;
            }

            if (!password || password.length === 0) {
                showFieldError('password', 'Şifre gerekli!');
                hasError = true;
            } else if (password.length < 4) {  // Validator'a göre minimum 4
                showFieldError('password', 'Şifre en az 4 karakter olmalıdır!');
                hasError = true;
            }

            if (!confirmPassword || confirmPassword.length === 0) {
                showFieldError('confirmPassword', 'Şifre tekrar gerekli!');
                hasError = true;
            }

            // Şifre eşleştirme kontrolü
            if (password && confirmPassword && password !== confirmPassword) {

                showFieldError('confirmPassword', 'Şifreler eşleşmiyor!');
                Swal.fire({
                    title: 'Validasyon Hatası!',
                    text: 'Şifreler eşleşmiyor!',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                hasError = true;
            }

            if (hasError) {

                return;
            }

            const submitData = {
                UserName: userName.trim(),
                EMail: email.trim(),
                Password: password,
                ConfirmPassword: confirmPassword
            };



            try {
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...').prop('disabled', true);

                // CSRF token al
                let token = $('input[name="__RequestVerificationToken"]').val();
                if (!token) {
                    token = $('meta[name="RequestVerificationToken"]').attr('content');
                }

                const response = await fetch('/SuperAdmin/CreateUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || ''
                    },
                    body: JSON.stringify(submitData)
                });



                if (response.ok) {
                    const data = await response.json();
   

                    if (data.success) {
                        $('#addUserModal').modal('hide');
                        Swal.fire({
                            title: 'Başarılı!',
                            text: 'Kullanıcı başarıyla eklendi!',
                            icon: 'success',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Hata!',
                            text: 'Kullanıcı eklenirken hata oluştu: ' + (data.message || 'Bilinmeyen hata'),
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    }
                } else {
 
                    const errorText = await response.text();


                    Swal.fire({
                        title: 'Hata!',
                        text: 'HTTP ' + response.status + ' hatası oluştu',
                        icon: 'error',
                        confirmButtonColor: '#d33'
                    });
                }

                submitBtn.html(originalText).prop('disabled', false);
            } catch (error) {
                console.error('Network Error:', error);
                Swal.fire({
                    title: 'Bağlantı Hatası!',
                    text: 'Server ile bağlantı kurulamadı: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });

                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.html('<i class="fas fa-save"></i> Kullanıcıyı Kaydet').prop('disabled', false);
            }
        });

        // Kullanıcı düzenleme form submit
        $('#editUserForm').on('submit', async function(e) {
            e.preventDefault();

            await new Promise(resolve => setTimeout(resolve, 100));

            const form = document.getElementById('editUserForm');
            const formData = new FormData(form);

            const userId = formData.get('userId') || document.getElementById('editUserId').value;
            const userName = formData.get('userName') || document.getElementById('editUserName').value;
            const email = formData.get('email') || document.getElementById('editEmail').value;
            const password = formData.get('password') || document.getElementById('editPassword').value;
            const confirmPassword = formData.get('confirmPassword') || document.getElementById('editConfirmPassword').value;

            const submitData = {
                UserName: userName.trim(),
                EMail: email.trim(),
                Password: password || null,
                ConfirmPassword: confirmPassword || null
            };

            // Basit validasyon
            if (password && confirmPassword && password !== confirmPassword) {
                showFieldError('editConfirmPassword', 'Şifreler eşleşmiyor!');
                Swal.fire({
                    title: 'Validasyon Hatası!',
                    text: 'Şifreler eşleşmiyor!',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            if (password && password.length < 4) {
                showFieldError('editPassword', 'Şifre en az 4 karakter olmalıdır!');
                Swal.fire({
                    title: 'Validasyon Hatası!',
                    text: 'Şifre en az 4 karakter olmalıdır!',
                    icon: 'warning',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            try {
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Güncelleniyor...').prop('disabled', true);

                let token = $('input[name="__RequestVerificationToken"]').val();
                if (!token) {
                    token = $('meta[name="RequestVerificationToken"]').attr('content');
                }

                const response = await fetch(`/SuperAdmin/UpdateUser?userId=${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || ''
                    },
                    body: JSON.stringify(submitData)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        $('#editUserModal').modal('hide');
                        Swal.fire({
                            title: 'Başarılı!',
                            text: 'Kullanıcı başarıyla güncellendi!',
                            icon: 'success',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Hata!',
                            text: 'Kullanıcı güncellenirken hata oluştu: ' + (data.message || 'Bilinmeyen hata'),
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    Swal.fire({
                        title: 'Hata!',
                        text: 'Kullanıcı güncellenirken hata oluştu: ' + (errorData.message || 'HTTP ' + response.status),
                        icon: 'error',
                        confirmButtonColor: '#d33'
                    });
                }

                submitBtn.html(originalText).prop('disabled', false);
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Bağlantı Hatası!',
                    text: 'Server ile bağlantı kurulamadı.',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });

                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.html('<i class="fas fa-save"></i> Güncelle').prop('disabled', false);
            }
        });

        function deleteUser(userId, userName) {
            Swal.fire({
                title: 'Kullanıcıyı Sil',
                html: `<strong>"${userName}"</strong> kullanıcısını silmek istediğinize emin misiniz?<br><br><small class="text-muted">Bu işlem geri alınamaz!</small>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash"></i> Evet, Sil!',
                cancelButtonText: '<i class="fas fa-times"></i> İptal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Siliniyor...',
                        html: 'Kullanıcı silme işlemi gerçekleştiriliyor',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    let token = $('input[name="__RequestVerificationToken"]').val();
                    if (!token) {
                        token = $('meta[name="RequestVerificationToken"]').attr('content');
                    }

                    fetch(`/SuperAdmin/DeleteUser?userId=${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'RequestVerificationToken': token || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Başarılı!',
                                text: 'Kullanıcı başarıyla silindi.',
                                icon: 'success',
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Hata!',
                                text: 'Kullanıcı silinirken hata oluştu: ' + (data.message || 'Bilinmeyen hata'),
                                icon: 'error',
                                confirmButtonColor: '#d33'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Bağlantı Hatası!',
                            text: 'Server ile bağlantı kurulamadı.',
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    });
                }
            });
        }

        function viewUserDetails(userId) {
            $('#userDetailModal').modal('show');

            $.get(`/SuperAdmin/GetUserById?userId=${userId}`, function(response) {
 

                if (response && response.success && response.data) {
                    const user = response.data;
 

                    let rolesHtml = '';

                    if (user.roles && user.roles.length > 0) {
                        user.roles.forEach(role => {
                            let badgeClass = 'bg-secondary';
                            let icon = 'fas fa-user';

                            if (role === 'SuperAdmin') {
                                badgeClass = 'bg-warning text-dark';
                                icon = 'fas fa-crown';
                            } else if (role === 'Admin') {
                                badgeClass = 'bg-primary';
                                icon = 'fas fa-user-shield';
                            } else if (role === 'Destek') {
                                badgeClass = 'bg-info';
                                icon = 'fas fa-headset';
                            }

                            rolesHtml += `<span class="badge ${badgeClass} me-1"><i class="${icon}"></i> ${role}</span>`;
                        });
                    } else {
                        rolesHtml = '<span class="text-muted">Rol atanmamış</span>';
                    }

                    const html = `
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Kullanıcı Adı:</strong><br>
                                <span class="fs-5">${user.userName || 'Belirtilmemiş'}</span><br><br>
                                <strong>Email:</strong><br>
                                <span class="fs-6">${user.eMail || user.email || 'Belirtilmemiş'}</span><br><br>
                                <strong>Email Onayı:</strong><br>
                                ${user.emailConfirmed ? '<span class="badge bg-success"><i class="fas fa-check"></i> Onaylı</span>' : '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Bekliyor</span>'}
                            </div>
                            <div class="col-md-6">
                                <strong>Kayıt Tarihi:</strong><br>
                                ${user.createdDate ? new Date(user.createdDate).toLocaleString('tr-TR') : '-'}<br><br>
                                <strong>Son Güncelleme:</strong><br>
                                ${user.updatedDate ? new Date(user.updatedDate).toLocaleString('tr-TR') : '-'}<br><br>
                                <strong>Roller:</strong><br>
                                ${rolesHtml}
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12 text-center">
                                <a href="/SuperAdmin/AssignRoles?userId=${userId}" class="btn btn-primary">
                                    <i class="fas fa-user-tag"></i> Rol Yönetimi
                                </a>
                            </div>
                        </div>
                    `;

                    $('#userDetailContent').html(html);
                } else {
                    console.error('Invalid API response:', response);
                    $('#userDetailContent').html('<div class="alert alert-danger">Kullanıcı detayları yüklenemedi.</div>');
                }
            }).fail(function(xhr, status, error) {
                console.error('AJAX Error:', {xhr, status, error});
                $('#userDetailContent').html('<div class="alert alert-danger">Bağlantı hatası oluştu.</div>');
                Swal.fire({
                    title: 'Bağlantı Hatası!',
                    text: 'Kullanıcı detayları yüklenemedi: ' + error,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            });
        }

        // Modal kapandığında form temizle
        $('#addUserModal').on('hidden.bs.modal', function () {
            $('#addUserForm')[0].reset();
            $('#addUserForm .is-invalid, #addUserForm .is-valid').removeClass('is-invalid is-valid');
        });

        $('#editUserModal').on('hidden.bs.modal', function () {
            $('#editUserForm')[0].reset();
            $('#editUserForm .is-invalid, #editUserForm .is-valid').removeClass('is-invalid is-valid');
        });
    </script>
}