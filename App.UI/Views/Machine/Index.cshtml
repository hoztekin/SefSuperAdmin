
@model List<MachineListViewModel>

@{
    ViewData["Title"] = "Makine Yönetimi";
}

<!-- ViewComponent Navigation -->
@await Component.InvokeAsync("RoleBasedNavigation", new { showLogo = true })


<div class="container-fluid">
 

            <div class="row mb-4">
                <div class="col-12">
                    <h2><i class="fas fa-tachometer-alt"></i> Makine Yönetimi Dashboard</h2>
                    <p class="text-muted">Makine yönetimi ve istatistikleri</p>
                </div>
            </div>
            <!-- Özet Kartları -->
            <div class="row mb-4">
                <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                    <div class="card card-outline-primary">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm rounded-circle bg-primary">
                                        <span class="avatar-title rounded-circle text-white">
                                            <i class="bx bx-desktop fs-4"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="text-muted mb-2">Toplam Makine</p>
                                    <h4 class="mb-0">@Model.Count</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                    <div class="card card-outline-success">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm rounded-circle bg-success">
                                        <span class="avatar-title rounded-circle text-white">
                                            <i class="bx bx-check-circle fs-4"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="text-muted mb-2">Aktif Makine</p>
                                    <h4 class="mb-0">@Model.Count(m => m.IsActive)</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                    <div class="card card-outline-warning">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm rounded-circle bg-warning">
                                        <span class="avatar-title rounded-circle text-white">
                                            <i class="bx bx-pause-circle fs-4"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="text-muted mb-2">Pasif Makine</p>
                                    <h4 class="mb-0">@Model.Count(m => !m.IsActive)</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                    <div class="card card-outline-info">
                        <div class="card-body">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <div class="avatar-sm rounded-circle bg-info">
                                        <span class="avatar-title rounded-circle text-white">
                                            <i class="bx bx-buildings fs-4"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="text-muted mb-2">Toplam Şube</p>
                                    <h4 class="mb-0">@Model.Select(m => m.BranchId).Distinct().Count()</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ana İçerik -->
            <div class="row">
                <div class="col">
                    <section class="card">
                        <header class="card-header">
                            <div class="card-actions float-end">
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createMachineModal">
                                    <i class="bx bx-plus me-1"></i> Yeni Makine Ekle
                                </button>
                            </div>
                            <h2 class="card-title">
                                <i class="bx bx-desktop me-2"></i>Makine Listesi
                            </h2>
                            <p class="card-subtitle text-muted">Sistemdeki tüm makineleri yönetin ve durumlarını kontrol edin</p>
                        </header>
                        <div class="card-body">
                            @if (Model.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-hover mb-0" id="machineTable">
                                        <thead>
                                            <tr>
                                                <th width="80" class="text-center">Durum</th>
                                                <th>Şube Bilgileri</th>
                                                <th>Makine Detayları</th>
                                                <th>API Adresi</th>
                                                <th width="140" class="text-center">İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var machine in Model)
                                            {
                                                <tr>
                                                    <td class="text-center">
                                                        <div class="form-check form-switch d-flex justify-content-center">
                                                            <input class="form-check-input status-toggle"
                                                                   type="checkbox"
                                                                   @(machine.IsActive ? "checked" : "")
                                                                   data-id="@machine.Id"
                                                                   title="@(machine.IsActive ? "Aktif" : "Pasif")" />
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm rounded-circle bg-light me-2">
                                                                <span class="avatar-title rounded-circle text-primary">
                                                                    <i class="bx bx-buildings"></i>
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">@machine.BranchName</h6>
                                                                <small class="text-muted">ID: @machine.BranchId</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm rounded-circle bg-light me-2">
                                                                <span class="avatar-title rounded-circle text-info">
                                                                    <i class="bx bx-desktop"></i>
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <h6 class="mb-0">@machine.Code</h6>
                                                                <small class="text-muted">@machine.CreatedDate.ToString("dd.MM.yyyy HH:mm")</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <span class="text-truncate me-2" style="max-width: 200px;" title="@machine.ApiAddress">
                                                                @machine.ApiAddress
                                                            </span>
                                                            <button type="button" class="btn btn-outline-secondary btn-sm test-connection"
                                                                    data-api="@machine.ApiAddress" title="Bağlantı Testi">
                                                                <i class="bx bx-wifi"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-info btn-sm view-machine"
                                                                    data-id="@machine.Id" title="Detay">
                                                                <i class="bx bx-show"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-warning btn-sm edit-machine"
                                                                    data-id="@machine.Id" title="Düzenle">
                                                                <i class="bx bx-edit"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-danger btn-sm delete-machine"
                                                                    data-id="@machine.Id"
                                                                    data-name="@machine.BranchName"
                                                                    title="Sil">
                                                                <i class="bx bx-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <div class="avatar-xl mx-auto mb-4">
                                        <span class="avatar-title rounded-circle bg-light text-muted">
                                            <i class="bx bx-desktop" style="font-size: 3rem;"></i>
                                        </span>
                                    </div>
                                    <h4>Henüz makine bulunmuyor</h4>
                                    <p class="text-muted">Sisteme ilk makineyi eklemek için aşağıdaki butona tıklayın.</p>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMachineModal">
                                        <i class="bx bx-plus me-1"></i> İlk Makineyi Ekle
                                    </button>
                                </div>
                            }
                        </div>
                    </section>
                </div>
            </div>
     
</div>

<!-- Yeni Makine Ekleme Modal -->
<div class="modal fade" id="createMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-plus-circle me-2 text-primary"></i> Yeni Makine Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createMachineForm">
                <div class="modal-body">
                    <div class="row">
                        <!-- Şube Bilgileri -->
                        <div class="col-12 mb-3">
                            <h6 class="text-primary"><i class="bx bx-buildings me-2"></i> Şube Bilgileri</h6>
                            <hr>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Şube Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="createBranchName" name="BranchName"
                                       placeholder="Örn: Ana Merkez Şubesi" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Şube ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="createBranchId" name="BranchId"
                                       placeholder="Örn: BRANCH-001" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Makine Bilgileri -->
                        <div class="col-12 mb-3 mt-3">
                            <h6 class="text-primary"><i class="bx bx-desktop me-2"></i> Makine Bilgileri</h6>
                            <hr>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Makine Kodu <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="createCode" name="Code"
                                       placeholder="Örn: MC-001" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">API Adresi <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="createApiAddress" name="ApiAddress"
                                           placeholder="https://api.example.com" required>
                                    <button type="button" class="btn btn-outline-secondary" id="testCreateConnection">
                                        <i class="bx bx-wifi"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Örnekler -->
                        <div class="col-12 mt-3">
                            <div class="alert alert-info">
                                <h6><i class="bx bx-info-circle me-2"></i> Örnekler</h6>
                                <small>
                                    <strong>Şube ID:</strong> MAIN-001, IST-002<br>
                                    <strong>Makine Kodu:</strong> MC-001, DEVICE-A1<br>
                                    <strong>API:</strong> https://api.example.com, http://192.168.1.100:8080
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bx bx-save me-1"></i> Makineyi Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Makine Düzenleme Modal -->
<div class="modal fade" id="editMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-edit me-2 text-warning"></i> Makine Düzenle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editMachineForm">
                <input type="hidden" id="editId" name="Id">
                <div class="modal-body">
                    <div class="row">
                        <!-- Şube Bilgileri -->
                        <div class="col-12 mb-3">
                            <h6 class="text-warning"><i class="bx bx-buildings me-2"></i> Şube Bilgileri</h6>
                            <hr>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Şube Adı <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editBranchName" name="BranchName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Şube ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editBranchId" name="BranchId" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Makine Bilgileri -->
                        <div class="col-12 mb-3 mt-3">
                            <h6 class="text-warning"><i class="bx bx-desktop me-2"></i> Makine Bilgileri</h6>
                            <hr>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Makine Kodu <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editCode" name="Code" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">API Adresi <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="editApiAddress" name="ApiAddress" required>
                                    <button type="button" class="btn btn-outline-secondary" id="testEditConnection">
                                        <i class="bx bx-wifi"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bx bx-save me-1"></i> Değişiklikleri Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Makine Detay Modal -->
<div class="modal fade" id="viewMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bx bx-show me-2 text-info"></i> Makine Detayları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="machineDetails">
                <!-- Detaylar buraya gelecek -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div class="modal fade" id="deleteMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Makine Silme Onayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="avatar-lg mx-auto mb-3">
                        <span class="avatar-title rounded-circle bg-danger-subtle text-danger">
                            <i class="bx bx-trash" style="font-size: 2rem;"></i>
                        </span>
                    </div>
                    <h5>Makine Silinecek!</h5>
                    <p class="text-muted">
                        <strong id="deleteMachineName"></strong> adlı makineyi silmek istediğinizden emin misiniz?
                        Bu işlem geri alınamaz.
                    </p>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteMachine">
                    <i class="bx bx-trash me-1"></i> Evet, Sil
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bağlantı Test Sonucu Modal -->
<div class="modal fade" id="connectionTestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bağlantı Testi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="connectionTestBody">
                <!-- Test sonucu buraya gelecek -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables sadece tablo varsa yükle
            if ($('#machineTable').length > 0) {
                // DataTables CSS ve JS'i dinamik yükle
                if (!$.fn.DataTable) {
                    $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/css/dataTables.bootstrap5.min.css">');
                    $.getScript('https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/js/jquery.dataTables.min.js', function() {
                        $.getScript('https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.24/js/dataTables.bootstrap5.min.js', function() {
                            initDataTable();
                        });
                    });
                } else {
                    initDataTable();
                }
            }

            // DataTable başlat
            function initDataTable() {
                $('#machineTable').DataTable({
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/tr.json'
                    },
                    responsive: true,
                    columnDefs: [
                        { orderable: false, targets: [0, 4] }
                    ],
                    order: [[2, 'asc']]
                });
            }

            // Form validation helper
            function clearFormErrors(form) {
                form.find('.is-invalid').removeClass('is-invalid');
                form.find('.invalid-feedback').text('');
            }

            function showFormErrors(form, errors) {
                clearFormErrors(form);
                if (Array.isArray(errors)) {
                    errors.forEach(error => {
                        if (error.toLowerCase().includes('kod')) {
                            form.find('[name="Code"]').addClass('is-invalid').siblings('.invalid-feedback').text(error);
                        } else if (error.toLowerCase().includes('branch') || error.toLowerCase().includes('şube')) {
                            form.find('[name="BranchId"]').addClass('is-invalid').siblings('.invalid-feedback').text(error);
                        } else {
                            // Genel hata için tüm alanları işaretle
                            form.find('input').first().addClass('is-invalid').siblings('.invalid-feedback').text(error);
                        }
                    });
                }
            }

            // Yeni makine ekleme
            $('#createMachineForm').on('submit', function (e) {
                e.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');

                // Loading state
                submitBtn.prop('disabled', true).html('<i class="bx bx-loader bx-spin me-1"></i> Kaydediliyor...');
                clearFormErrors(form);

                const formData = {
                    BranchName: form.find('#createBranchName').val(),
                    BranchId: form.find('#createBranchId').val(),
                    Code: form.find('#createCode').val(),
                    ApiAddress: form.find('#createApiAddress').val()
                };

                $.ajax({
                    url: '@Url.Action("Create")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#createMachineModal').modal('hide');
                            form[0].reset();
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı!',
                                text: 'Makine başarıyla oluşturuldu',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            showFormErrors(form, response.errors);
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: response.message || 'Makine oluşturulamadı'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Beklenmeyen bir hata oluştu'
                        });
                    },
                    complete: function () {
                        submitBtn.prop('disabled', false).html('<i class="bx bx-save me-1"></i> Makineyi Kaydet');
                    }
                });
            });

            // Event Delegation - Dinamik content için $(document).on() kullan
            // Makine düzenleme modal açma
            $(document).on('click', '.edit-machine', function () {
                const machineId = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("GetById")',
                    type: 'GET',
                    data: { id: machineId },
                    success: function (response) {
                        if (response.success && response.data) {
                            const machine = response.data;
                            $('#editId').val(machine.id);
                            $('#editBranchName').val(machine.branchName);
                            $('#editBranchId').val(machine.branchId);
                            $('#editCode').val(machine.code);
                            $('#editApiAddress').val(machine.apiAddress);
                            $('#editMachineModal').modal('show');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: 'Makine bilgileri yüklenemedi'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Makine bilgileri yüklenemedi'
                        });
                    }
                });
            });

            // Makine güncelleme
            $('#editMachineForm').on('submit', function (e) {
                e.preventDefault();
                const form = $(this);
                const submitBtn = form.find('button[type="submit"]');

                submitBtn.prop('disabled', true).html('<i class="bx bx-loader bx-spin me-1"></i> Güncelleniyor...');
                clearFormErrors(form);

                const formData = {
                    Id: form.find('#editId').val(),
                    BranchName: form.find('#editBranchName').val(),
                    BranchId: form.find('#editBranchId').val(),
                    Code: form.find('#editCode').val(),
                    ApiAddress: form.find('#editApiAddress').val()
                };

                $.ajax({
                    url: '@Url.Action("Edit")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#editMachineModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı!',
                                text: 'Makine başarıyla güncellendi',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            showFormErrors(form, response.errors);
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: response.message || 'Makine güncellenemedi'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Beklenmeyen bir hata oluştu'
                        });
                    },
                    complete: function () {
                        submitBtn.prop('disabled', false).html('<i class="bx bx-save me-1"></i> Değişiklikleri Kaydet');
                    }
                });
            });

            // Makine detay görüntüleme
            $(document).on('click', '.view-machine', function () {
                const machineId = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("GetById")',
                    type: 'GET',
                    data: { id: machineId },
                    success: function (response) {
                        if (response.success && response.data) {
                            const machine = response.data;
                            const detailsHtml = `
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary"><i class="bx bx-buildings me-2"></i> Şube Bilgileri</h6>
                                        <table class="table table-borderless">
                                            <tr><th width="40%">Şube Adı:</th><td>${machine.branchName}</td></tr>
                                            <tr><th>Şube ID:</th><td><span class="badge bg-primary">${machine.branchId}</span></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info"><i class="bx bx-desktop me-2"></i> Makine Bilgileri</h6>
                                        <table class="table table-borderless">
                                            <tr><th width="40%">Makine Kodu:</th><td><span class="badge bg-info">${machine.code}</span></td></tr>
                                            <tr><th>Durum:</th><td><span class="badge ${machine.isActive ? 'bg-success' : 'bg-warning'}">${machine.isActive ? 'Aktif' : 'Pasif'}</span></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <h6 class="text-success"><i class="bx bx-link me-2"></i> API Bilgileri</h6>
                                        <table class="table table-borderless">
                                            <tr><th width="20%">API Adresi:</th><td><code>${machine.apiAddress}</code></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <h6 class="text-muted"><i class="bx bx-time me-2"></i> Zaman Bilgileri</h6>
                                        <table class="table table-borderless">
                                            <tr><th width="20%">Oluşturma:</th><td>${new Date(machine.createdDate).toLocaleString('tr-TR')}</td></tr>
                                            <tr><th>Oluşturan:</th><td>${machine.createdBy || 'Sistem'}</td></tr>
                                            ${machine.updatedDate ? `<tr><th>Son Güncelleme:</th><td>${new Date(machine.updatedDate).toLocaleString('tr-TR')}</td></tr>` : ''}
                                            ${machine.updatedBy ? `<tr><th>Güncelleyen:</th><td>${machine.updatedBy}</td></tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                            `;
                            $('#machineDetails').html(detailsHtml);
                            $('#viewMachineModal').modal('show');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: 'Makine detayları yüklenemedi'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Makine detayları yüklenemedi'
                        });
                    }
                });
            });

            // Durum değiştirme - Event Delegation
            $(document).on('change', '.status-toggle', function () {
                const checkbox = $(this);
                const machineId = checkbox.data('id');
                const isActive = checkbox.is(':checked');

                checkbox.prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("ToggleStatus")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ id: machineId, isActive: isActive }),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            checkbox.prop('title', isActive ? 'Aktif' : 'Pasif');
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı!',
                                text: response.message,
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000
                            });
                        } else {
                            checkbox.prop('checked', !isActive);
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: response.message
                            });
                        }
                    },
                    error: function () {
                        checkbox.prop('checked', !isActive);
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: 'Durum değiştirilemedi!'
                        });
                    },
                    complete: function () {
                        checkbox.prop('disabled', false);
                    }
                });
            });

            // Silme işlemi - Event Delegation
            let machineIdToDelete = null;
            $(document).on('click', '.delete-machine', function () {
                machineIdToDelete = $(this).data('id');
                const machineName = $(this).data('name');
                $('#deleteMachineName').text(machineName);
                $('#deleteMachineModal').modal('show');
            });

            $('#confirmDeleteMachine').on('click', function () {
                if (machineIdToDelete) {
                    $.ajax({
                        url: '@Url.Action("Delete")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ id: machineIdToDelete }),
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            $('#deleteMachineModal').modal('hide');
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Başarılı!',
                                    text: 'Makine başarıyla silindi',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Hata!',
                                    text: response.message || 'Makine silinemedi'
                                });
                            }
                        },
                        error: function () {
                            $('#deleteMachineModal').modal('hide');
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: 'Makine silinemedi!'
                            });
                        }
                    });
                }
            });

            // API Bağlantı Testi
            function testConnection(apiAddress, button) {
                button.prop('disabled', true).html('<i class="bx bx-loader bx-spin"></i>');

                $.ajax({
                    url: '@Url.Action("TestConnection")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ apiAddress: apiAddress }),
                    success: function (response) {
                        let icon, bgClass, textClass;

                        if (response.success && response.connected) {
                            icon = 'bx-wifi';
                            bgClass = 'bg-success-subtle';
                            textClass = 'text-success';
                        } else {
                            icon = 'bx-wifi-off';
                            bgClass = 'bg-danger-subtle';
                            textClass = 'text-danger';
                        }

                        $('#connectionTestBody').html(`
                            <div class="avatar-lg mx-auto mb-3">
                                <span class="avatar-title rounded-circle ${bgClass} ${textClass}">
                                    <i class="bx ${icon}" style="font-size: 2rem;"></i>
                                </span>
                            </div>
                            <h6>${response.message}</h6>
                            <small class="text-muted">${apiAddress}</small>
                        `);

                        $('#connectionTestModal').modal('show');
                    },
                    error: function () {
                        $('#connectionTestBody').html(`
                            <div class="avatar-lg mx-auto mb-3">
                                <span class="avatar-title rounded-circle bg-danger-subtle text-danger">
                                    <i class="bx bx-wifi-off" style="font-size: 2rem;"></i>
                                </span>
                            </div>
                            <h6>Bağlantı testi başarısız</h6>
                            <small class="text-muted">${apiAddress}</small>
                        `);
                        $('#connectionTestModal').modal('show');
                    },
                    complete: function () {
                        button.prop('disabled', false).html('<i class="bx bx-wifi"></i>');
                    }
                });
            }

            // Tablodan bağlantı testi - Event Delegation
            $(document).on('click', '.test-connection', function () {
                const button = $(this);
                const apiAddress = button.data('api');
                testConnection(apiAddress, button);
            });

            // Create modal'dan bağlantı testi
            $('#testCreateConnection').on('click', function () {
                const button = $(this);
                const apiAddress = $('#createApiAddress').val();
                if (!apiAddress) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı!',
                        text: 'Lütfen önce API adresini girin'
                    });
                    return;
                }
                testConnection(apiAddress, button);
            });

            // Edit modal'dan bağlantı testi
            $('#testEditConnection').on('click', function () {
                const button = $(this);
                const apiAddress = $('#editApiAddress').val();
                if (!apiAddress) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Uyarı!',
                        text: 'Lütfen önce API adresini girin'
                    });
                    return;
                }
                testConnection(apiAddress, button);
            });

            // Modal temizleme
            $('#createMachineModal').on('hidden.bs.modal', function () {
                $('#createMachineForm')[0].reset();
                clearFormErrors($('#createMachineForm'));
            });

            $('#editMachineModal').on('hidden.bs.modal', function () {
                clearFormErrors($('#editMachineForm'));
            });
        });
    </script>
}