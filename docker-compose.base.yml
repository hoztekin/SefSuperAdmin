services:
  sql-server:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment: [ "ACCEPT_EULA=Y", "SA_PASSWORD=${SQL_SERVER_PASSWORD}" ]
    ports: ["1433:1433"]
    healthcheck:
      test: ["CMD-SHELL","bash -c '</dev/tcp/localhost/1433'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks: [app-network]
    volumes: [sql-data:/var/opt/mssql]

  app-redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports: ["6379:6379"]
    healthcheck: { test: ["CMD","redis-cli","--raw","incr","ping"], interval: 10s, timeout: 5s, retries: 3, start_period: 10s }
    networks: [app-network]
    volumes: [redis-data:/data]

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports: ["5672:5672","15672:15672"]
    environment: [ "RABBITMQ_DEFAULT_USER=${RABBITMQ_USERNAME}", "RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}" ]
    healthcheck: { test: ["CMD","rabbitmq-diagnostics","ping"], interval: 30s, timeout: 10s, retries: 3, start_period: 30s }
    networks: [app-network]
    volumes: [rabbitmq-data:/var/lib/rabbitmq]

  seq:
    image: datalust/seq:latest
    environment: [ "ACCEPT_EULA=Y", "SEQ_FIRSTRUN_ADMINUSERNAME=${SEQ_CONTAINER_ADMIN_USER}", "SEQ_FIRSTRUN_ADMINPASSWORD=${SEQ_CONTAINER_ADMIN_PASSWORD}" ]
    ports: ["5341:80"]
    networks: [app-network]
    volumes: [seq-data:/data]

networks: { app-network: { driver: bridge } }
volumes: { sql-data: {}, redis-data: {}, rabbitmq-data: {}, seq-data: {} }
